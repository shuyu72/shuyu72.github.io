<!DOCTYPE html>

<html lang="en">
    <head>
        
        <meta name="viewport" content="width=100%, initial-scale=1.1, user-scalable=no" />
        <script src="html5-qrcode.min.js"></script>
        <script src="index.js"></script>
        <script src="https://raw.githubusercontent.com/mebjas/html5-qrcode/master/minified/html5-qrcode.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>   
    </head>
    <body>
        <h1 id="result"></h1>
        <div class="row" id="btnGrp">            
            <div class="col-2 col-xs-2"></div>
            <div class="btn btn-success" id="todayDataDownload" onclick="downloadDateClickEvent(todayWithoutSlash)" hidden="true">當前資料下載</div>
            <div class="col-2 col-xs-2"></div>  
        </div>
        <div id="panel"></div>
        <div class="container">
        <div class="text-center my-5">
        </div>
        <div class="row my-3 d-flex justify-content-center text-center">
            <div id="orderIdGrp" class="row mx-1">
                <h5 class="my-1 mx-1">單號:</h5>                
            </div>
            <div class="text-center justify-content-center my-0 row">
                <h5 class="my-1 mx-1" id="orderIdH5" hidden="true"></h5>
                <div class="btn btn-danger px-3 reset-input" id="orderIdclear" onclick="modifyOrderId()" hidden="true">×</div>
                <div class="mx-0 input-group col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">                    
                        <input class="form-control mx-0" type="text" id="orderIdInput" placeholder="掃描或輸入單號"/>
                        <div class="input-group-append">                
                            <div class="btn btn-primary mx-0 px-1" id="ensureOrderIdBtn" onclick="newOrder()">確認</div>
                        </div>
                        <div class="input-group-append">                
                            <div class="btn btn-warning mx-0 px-1" id="scanOrderIdBtn" onclick="showScanner()">掃描</div>
                        </div>                    
                </div>
            
        
        <!-- <div class="row table-row text-center"> -->
            <div id="qr-reader" class="col-xs-12 my-1" style="width:100%;" hidden="true"></div>
            <div id="qr-reader-results"></div>
        <!-- </div> -->
        <div class="text-center justify-content-center my-2 row">
            <div class="mx-0 input-group col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <input type="text" class="form-control" placeholder="掃描或輸入條碼" id="inputBarCode"/>
                <div class="input-group-append">                
                    <div class="btn btn-danger px-1 reset-input" onclick="clearInput('inputBarCode')">×</div>
                </div>
                <div class="input-group-append">                
                    <div class="btn btn-primary px-3" onclick="newRecord()">確認</div>
                </div>                
            </div>        
        <!-- </div> -->
        <div class="mx-1 float-xs-left">            
        <div class="container">
            <br>            
              <div class="text-center table-wrapper">                                                  
                <table class="table">
                  <thead>
                    <tr>
                      <th class="col-xs-1">項次</th>                      
                      <th class="col-xs-2">條碼</th>
                      <th class="col-xs-2">暗記</th>                      
                      <th class="col-xs-2">移除</th>
                    </tr>
                  </thead>
                  <tbody>                    
                  </tbody>
                </table>
              </div>
            </div>    
        
                
        <div class="row my-5 mx-0 inline-block">
            <div class="col-3 col-md-3"></div>        
            <div class="col-3 col-md-3">
                <div class="btn btn-info" onclick="confirmClearThis()">重置</div>
            </div>
            <div class="col-3 col-md-3">                
                <div class="btn btn-danger" onclick="end()">完成</div>
            </div>
            <div class="col-3 col-md-3"></div>        
        </div>
        </div>
    </div>
</div>
</div>
    <script>
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');                
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();
        var today = yyyy + '/' + mm + '/' + dd;
        var todayWithoutSlash = yyyy + mm + dd;                            
        var needRefresh = false;
        const table_header = "no,orderId,code,hint,date";
        var isStarted = false;
        // var isBegun = false;
        var itemCount = 0;
        var thisOrderId;
        var confirmPopup = false;
        var hasConfirmed = false;        
        window.onload=function(){
            var dateSet = new Set();
            var currentDay = new Date();
            var dd = String(currentDay.getDate()).padStart(2, '0');
            var mm = String(currentDay.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = currentDay.getFullYear();
            var currentDay = yyyy + '/' + mm + '/' + dd;
            var v = null;
            if (localStorage.today !== currentDay) {
                // confirmPopup = false;                                                                
                for (var i = 0; i < localStorage.length; i++){
                    let t = localStorage.getItem(localStorage.key(i));
                    if (isJsonString(t)) {                            
                        v = JSON.parse(t);                
                        if (v["recordDate"] === localStorage.today) {
                            let userChoice = confirm('日前的工作紀錄尚未下載，是否下載?');
                            hasConfirmed = true;
                            if (userChoice === true) {                           
                                confirmPopup = true;
                                break;
                            }
                            
                        }
                    }
                }
                let data = "";
                if (confirmPopup) {                                        
                    for (var i = 0; i < localStorage.length; i++){
                        let t = localStorage.getItem(localStorage.key(i));
                        if (isJsonString(t)) {                            
                            v = JSON.parse(t);                
                            if (v["recordDate"] === localStorage.today) {                                                                    
                                data += v["table_content"];                                            
                            }
                        }
                    }

                    let date = new Date();
                        
                    let oprationDate = date.getFullYear().toString() + pad2(date.getMonth() + 1) + pad2(date.getDate()) + pad2(date.getHours()) + pad2(date.getMinutes()) + pad2(date.getSeconds());

                    let csvContent = "data:text/csv;charset=utf-8," + table_header + "%0A" + data;//.map(e => e.join(",")).join("\n");    
                    var link = document.createElement("a");
                    link.download = localStorage.todayWithoutSlash + "-" + oprationDate;
                    link.href = csvContent;
                    link.click();
                    
                }

                localStorage.today = currentDay; 
                localStorage.todayWithoutSlash = currentDaytodayWithoutSlash;                                      
                
                $('#orderIdInput').focus();
                if (typeof(localStorage.getItem("lastUsedDate")) === "undefined") {
                        localStorage.setItem(lastUsedDate, today);
                } else {                        
                    var currentDay = new Date();
                    var dd = String(currentDay.getDate()).padStart(2, '0');
                    var mm = String(currentDay.getMonth() + 1).padStart(2, '0'); //January is 0!
                    var yyyy = currentDay.getFullYear();
                    var currentDay = yyyy + '/' + mm + '/' + dd;
                    var currentDaytodayWithoutSlash = yyyy + mm + dd;

                    let todayDate = new Date(today);                            

                    if (typeof(Storage) !== "undefined") { 
                        var _lsTotal = 0,
                            _xLen, _x;
                        for (_x in localStorage) {
                            if (!localStorage.hasOwnProperty(_x)) {
                                continue;
                            }
                            _xLen = ((localStorage[_x].length + _x.length) * 2);
                            _lsTotal += _xLen;
                            console.log(_x.substr(0, 50) + " = " + (_xLen / 1024).toFixed(2) + " KB")
                        }
                        let prevDate = todayDate.setDate(todayDate.getDate() - 5);
                        if ((_lsTotal / 1024).toFixed(2) >= 4096) {                        
                            prevDate = todayDate.setDate(todayDate.getDate() - 4);  
                        }                             
                        
                        for (var i = 0; i < localStorage.length; i++) {                                    
                            let t = localStorage.getItem(localStorage.key(i));
                            if (isJsonString(t)) {
                                t = JSON.parse(t);
                                if (new Date(t["recordDate"]) <= new Date(prevDate)) {
                                    localStorage.removeItem(t["orderId"]);
                                } else {
                                    if (typeof(t['recordDate']) !== "undefined") {
                                        let test = t["table_content"].split('%0A')[0];
                                        // alert(test);
                                        // alert((test.match(new RegExp("%2C", "g") || []).length));
                                        if ((test.match(new RegExp("%2C", "g") || []).length) !== 4) {
                                            localStorage.removeItem(t["orderId"]);
                                        } else {
                                            dateSet.add(t['recordDate']);
                                        }
                                    }
                                }                                                                        
                            }
                        }                        
                    }   
                    
                    localStorage.today = today;
                    
                    let dateArr = Array.from(dateSet);                                                
                    for (let s = 0; s < dateArr.length; s++) {
                        if (dateArr[s] !== today) {    
                            tpl = '<div class="btn btn-success" id="todayDataDownload" onclick="downloadDateClickEvent(' + dateArr[s].replaceAll('/', '') + ')">' + dateArr[s] + '</div>';
                            $('#btnGrp').append($(tpl));
                        }
                    }                        
                }                

                isStarted = true;                    
                localStorage.todayWithoutSlash = todayWithoutSlash;
            }
            let count = 0;
            for (var i = 0; i < localStorage.length; i++){
                let t = localStorage.getItem(localStorage.key(i));
                if (isJsonString(t)) {                            
                    v = JSON.parse(t);                
                    if (v["recordDate"] === today) {                                    
                        data += v["table_content"];                                            
                        count++;
                    }                    
                }
            }
            if (count > 0) {
                $('#todayDataDownload').attr("hidden", false);   
            }                        
        }
        var isFinished = false;
        function end() {
            isFinished = true;
            isStarted = false;
            var tpl = '<a download="' + $('#orderIdH5').html() + '.csv" href="data:application/csv;charset=utf-8,{table_header}%0A{table_content}"><div id="downloadOrder" onclick="updateThisStatus()">下載此訂單</div></a>';
            var table_content = '';
            $('#todayDataDownload').attr("hidden", false);    
            $.each($("td"), function (index, cell) {
                var cellContent = cell.innerHTML;
                var td = '';                        
                if (index % 4 === 0 || index % 4 === 1) {
                    td = cellContent.split('<td>')[0];                                                                
                } else if (index % 4 === 2) {                                                               
                    td = $('#field' + (Math.trunc(index / 4)).toString()).val();
                }
                if (index % 4 === 0) {
                    table_content += td + '%2C'; //Need to return contents of cell
                    table_content += $('#orderIdH5').html() + '%2C';                                    
                } else if (index % 4 === 1) {
                    table_content += td + '%2C'; //Need to return contents of cell                                
                } else if (index % 4 === 2) {                            
                    table_content += td + '%2C';
                    table_content += today + '%0A';
                }                                
            });

                    

            var order = new Object(); 
            order.orderId = $('#orderIdH5').html();
            order.recordDate = localStorage.today;
            order.hasDownloaded = false;                 
            order.table_content = table_content;
            console.log("order::");
            console.log(order.orderId); 
            console.log(order.table_content);                
            localStorage.setItem($('#orderIdH5').html(), JSON.stringify(order));    

            
            var currentDay = new Date();
            var dd = String(currentDay.getDate()).padStart(2, '0');
            var mm = String(currentDay.getMonth() + 1).padStart(2, '0'); //January is 0!
            var yyyy = currentDay.getFullYear();
            var currentDay = yyyy + '/' + mm + '/' + dd;
            var currentDaytodayWithoutSlash = yyyy + mm + dd;
            
            tpl = tpl.replace('{table_header}', table_header);
            tpl = tpl.replace('{table_content}', table_content);
            console.log(tpl);
            $(tpl).appendTo($('#orderIdGrp'));
            clearTable();
            
        }
        
        function updateThisStatus() {                   
            // $('#orderId').html("");
            // alert($('#orderIdH5').html());
            console.log($('#orderIdH5').html());
            let order = localStorage.getItem($('#orderIdH5').html());
            console.log($('#orderIdH5').html());
            // let updatedOrder = new Object(order);
            console.log('ooo');
            updatedOrder = JSON.parse(order);
            updatedOrder["hasDownloaded"] = true; 
            localStorage.setItem($('#orderIdH5').html(), updatedOrder);
            isFinished = false;
            // alert(updatedOrder.hasDownloaded);
        }
        $(function(){
            function docReady(fn) {
                // see if DOM is already available
                if (document.readyState === "complete" || document.readyState === "interactive") {
                    // call on next available tick
                    setTimeout(fn, 1);
                } else {
                    document.addEventListener("DOMContentLoaded", fn);
                }
            } 

            docReady(function() {
                var resultContainer = document.getElementById('qr-reader-results');
                var lastResult, countResults = 0;
                
                var html5QrcodeScanner = new Html5QrcodeScanner(
                    "qr-reader", { fps: 10, qrbox: 250 });
                
                function onScanSuccess(decodedText, decodedResult) {
                    if ($('#orderIdInput').val() === "") {
                        $('#orderIdInput').val(decodedText);
                    } else {
                        $('#inputBarCode').val(decodedText);
                    }
                }
                
                // Optional callback for error, can be ignored.
                function onScanError(qrCodeError) {
                    // This callback would be called in case of qr code scan error or setup error.
                    // You can avoid this callback completely, as it can be very verbose in nature.
                }
                
                html5QrcodeScanner.render(onScanSuccess, onScanError);
            });
        });
        $(document).on("click", ".delete", function(){                                
            $(this).parents("tr").remove();                 
        });

        function clearInput(id) {
            $("#" + id).val("");
        }
        
        function newRecord() {
            if ($('#orderIdH5').html() === '') {
                alert('單號未輸入!');
                return;
            }            
            $('table').find('tbody').append('<tr><td>' + (itemCount + 1).toString() + '</td><td class="barcode">' + $('#inputBarCode').val() + '</td><td class="col-4 col-xs-4 col-sm-4 col-md-4 col-lg-4"><div class="input-group"><input type="text" id="field' + itemCount.toString() + '" class="form-control memo"/><div class="input-group-append"><div class="btn btn-danger px-1 reset-input" onclick="clearInput(\'field' + itemCount.toString() + '\')">×</div></div></div></td><td><div class="btn btn-danger delete">移除</div></td></tr>');
            $('#inputBarCode').val('');
            itemCount++;
            $('#inputBarCode').focus();
        }

        function newOrder() {
            $('#orderIdInput').attr("hidden", true);                                        
            $('#ensureOrderIdBtn').attr("hidden", true);
            $('#scanOrderIdBtn').attr("hidden", true);    
            $('#orderIdH5').html($('#orderIdInput').val());
            $('#orderIdH5').attr("hidden", false);
            $("#orderIdclear").attr("hidden", false);
            $('#inputBarCode').focus();
     
        }
        document.getElementById("orderIdInput").addEventListener("keyup", function(event) {
        // var orderIdElement = document.getElementById('orderIdInput');
        //     var isOrderIdFocused = (document.activeElement === orderIdElement);
   
            event.preventDefault();
            if (event.keyCode === 13) {
                alert('ooo');
                $("#ensureOrderIdBtn").click();
   
            }
        });
            

        function modifyOrderId() {                    
            $('#orderIdInput').attr("hidden", false);                                                            
            $('#ensureOrderIdBtn').attr("hidden", false);
            $('#scanOrderIdBtn').attr("hidden", false);
            $('#orderIdclear').attr("hidden", true);
            $('#orderIdH5').attr("hidden", true);
        }

        var confirmReset = false;

        function confirmClearThis() {
            confirmReset = true;
            // if (!isStarted) {
            if (!isFinished) {
                if (confirm("您確定要刪除此筆訂單的所有資料嗎?")) {
                    localStorage.removeItem(thisOrderId);
                    // isFinished = false;                                      
                    let count = 0;
                    for (var i = 0; i < localStorage.length; i++){
                        let t = localStorage.getItem(localStorage.key(i));
                        if (isJsonString(t)) {                            
                            v = JSON.parse(t);                
                            if (v["recordDate"] === today) {                                    
                                data += v["table_content"];                                            
                                count++;
                            }                    
                        }
                    }                    
                    if (count === 0) {
                        $('#todayDataDownload').attr("hidden", true);
                    }
                    
                } 
            } else {
                if (confirm("刪除此筆訂單目前的資料嗎?")) {
                    $('tr td').remove();                        
                    itemCount = 0;
                }
            }
            clearTable();
        }

        function clearTable() {
            isFinished = false;
            $('#orderId').html('');
            $('tr td').remove();
            itemCount = 0;                        
        }

        
        function showScanner() {
            $('#qr-reader').attr("hidden", false);
        }

        
        function pad2(n) { return n < 10 ? '0' + n : n }

        function isJsonString(str) {
            try {
                JSON.parse(str);
            } catch (e) {
                return false;
            }
            return true;
        }

        $(document).on("click", ".delete", function(){                                
            $(this).parents("tr").remove();                 
        });

        function clearInput(id) {
            $("#" + id).val("");
        }
        
        function newRecord() {
            if ($('#orderIdH5').html() === '') {
                alert('單號未輸入!');
                return;
            }
            $('table').find('tbody').append('<tr><td>' + (itemCount + 1).toString() + '</td><td class="barcode">' + $('#inputBarCode').val() + '</td><td class="col-4 col-xs-4 col-sm-4 col-md-4 col-lg-4"><div class="input-group"><input type="text" id="field' + itemCount.toString() + '" class="form-control memo"/><div class="input-group-append"><div class="btn btn-danger px-1 reset-input" onclick="clearInput(\'field' + itemCount.toString() + '\')">×</div></div></div></td><td><div class="btn btn-danger delete">移除</div></td></tr>');
            $('#inputBarCode').val('');
            itemCount++;
            $('#inputBarCode').focus();
        }

        function newOrder() {
            $('#orderIdInput').attr("hidden", true);                                        
            $('#ensureOrderIdBtn').attr("hidden", true);
            $('#scanOrderIdBtn').attr("hidden", true);    
            $('#orderIdH5').html($('#orderIdInput').val());
            $('#orderIdH5').attr("hidden", false);
            $("#orderIdclear").attr("hidden", false);
            $('#inputBarCode').focus();
        }

        function modifyOrderId() {                    
            $('#orderIdInput').attr("hidden", false);                                                            
            $('#ensureOrderIdBtn').attr("hidden", false);
            $('#scanOrderIdBtn').attr("hidden", false);
            $('#orderIdclear').attr("hidden", true);
            $('#orderIdH5').attr("hidden", true);
        }

        var confirmReset = false;        

        function downloadDateClickEvent(chosenDate) {
            
            chosenDate = chosenDate.toString().replace(/(\d{4})(\d{2})(\d{2})/g, '$1/$2/$3');
            let data = "";
            let count = 0;
            for (var i = 0; i < localStorage.length; i++){
                let t = localStorage.getItem(localStorage.key(i));
                if (isJsonString(t)) {                            
                    v = JSON.parse(t);                
                    if (v["recordDate"] === chosenDate) {                                    
                        data += v["table_content"];                                            
                        count++;
                    }                    
                }
            }

            if (count === 0) {
                alert("當前無資料");
                return;
            }
            let date = new Date();
                                
            let oprationDate = date.getFullYear().toString() + pad2(date.getMonth() + 1) + pad2(date.getDate()) + pad2(date.getHours()) + pad2(date.getMinutes()) + pad2(date.getSeconds());

            let csvContent = "data:text/csv;charset=utf-8," + table_header + "%0A" + data;//.map(e => e.join(",")).join("\n");    
            var link = document.createElement("a");
            chosenDate = chosenDate.replaceAll('/', '');
            link.download = chosenDate + "-" + oprationDate;                        
            link.href = csvContent;
            link.click();
        }
        

        function clearTable() {
            isFinished = false;
            $('#orderId').html('');
            $('tr td').remove();
            itemCount = 0;                        
        }

        
        function showScanner() {
            $('#qr-reader').attr("hidden", false);
        }
    </script>
</body>
</html>
